plugins {
    id 'java'
    id 'org.springframework.boot' version '3.4.5'
    id 'io.spring.dependency-management' version '1.1.7'
}
ext {
    springBootVersion = '3.2.5'
    useAltSrc = false
}
group = 'com.example'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(20)
    }
    sourceCompatibility = JavaVersion.VERSION_17  // –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Java 17
    targetCompatibility = JavaVersion.VERSION_17  // –±–∞–π—Ç-–∫–æ–¥ –ø–æ–¥ Java 17
}

repositories {
    mavenCentral()
}


dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web-services'

    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    implementation 'at.favre.lib:bcrypt:0.9.0'
    implementation 'org.postgresql:postgresql:42.4.5'
}

tasks.named('test') {
    useJUnitPlatform()
    enable = false
}

tasks.register('welcome') {
    group = 'custom'
    doLast {
        println "welcome from katya pim"
    }
}


tasks.register('custom-compile', Exec) {
    group = 'custom'
    description = '–∫–æ–º–ø–∏–ª—è—Ü–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞'

    def outputDir = layout.buildDirectory.dir("classes/java/main").get().asFile

    doFirst {
        def javaFiles = files(project.ext.useAltSrc ? layout.projectDirectory.dir("altSrc").asFile : sourceSets.main.java.srcDirs)
                .asFileTree
                .matching { include '**/*.java' }
                .files
                .toList()

        // —Ñ–æ—Ä–º–∏—Ä—É–µ–º classpath
        def deps = sourceSets.main.compileClasspath.asPath + ":" + sourceSets.test.compileClasspath.asPath
        def cp = [deps, outputDir.absolutePath].join(File.pathSeparator)

        delete(outputDir) // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã

        commandLine = ['javac',
                       '-parameters',
                       '-d', outputDir.absolutePath,
                       '-cp', cp] + javaFiles.collect { it.absolutePath }
    }
    doLast {
        println "‚úÖ–≤—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã –≤: ${outputDir.absolutePath.replace(projectDir.absolutePath + '/', '')}"
    }
}

tasks.register('custom-build', Jar) {
    group = 'custom'
    description = '–∫–æ–º–ø–∏–ª—è—Ü–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∏—Ö —É–ø–∞–∫–æ–≤–∫–∞ –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π jar-–∞—Ä—Ö–∏–≤. –ö–æ–º–ø–∏–ª—è—Ü–∏—é –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –≤—ã–∑–æ–≤–∞ —Ü–µ–ª–∏ compile'

    def libsDir = layout.buildDirectory.dir("libs/lib").get().asFile.absolutePath

    dependsOn 'custom-compile'     //  –∫–æ–º–ø–∏–ª—è—Ü–∏—è + –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ lib

    archiveBaseName = project.name
    archiveVersion = project.version.toString()

    copy {
        from configurations.runtimeClasspath
        into libsDir
    }

    from sourceSets.main.output

    manifest {
        attributes 'Main-Class': 'com.example.web4_2.Web4Application'

        def cpEntries = configurations.runtimeClasspath.files.collect {
            "lib/${it.name}"
        }
        attributes 'Class-Path': cpEntries.join(' ')
    }

    destinationDirectory = layout.buildDirectory.dir("libs")

    doLast {
        println "‚úÖjar-–∞—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –≤: ${archiveFile.get().asFile.absolutePath.replace(projectDir.absolutePath + '/', '')}"
    }
}


tasks.register('custom-clean', Exec) {
    group = "custom"
    description = "—É–¥–∞–ª–µ–Ω–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤, –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ jar-–∞—Ä—Ö–∏–≤–∞"

    def buildDir = layout.buildDirectory.get().asFile.absolutePath

    commandLine "rm", "-rf", buildDir

    doLast {
        println "‚úÖ–≤—Å–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ jar-–∞—Ä—Ö–∏–≤—ã —É–¥–∞–ª–µ–Ω—ã"
    }
}

tasks.register("custom-native2ascii") {

    group = "custom"
    description = "–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ native2ascii –¥–ª—è –∫–æ–ø–∏–π —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ " + "(–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è –≤—Å–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–Ω–µ—Å—Ç–∏ –∏–∑ –∫–ª–∞—Å—Å–æ–≤ –≤ —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏)"

    def convertToUnicode = new GroovyShell().evaluate(file('scripts/convertToUnicode.groovy'))


    def inputDir = file("src/main/resources/")
    def outputDir = layout.buildDirectory.dir("native2ascii").get().asFile

    inputs.dir inputDir
    outputs.dir outputDir

    doLast {
        if (!outputDir.exists()) {
            outputDir.mkdirs()
        }
        // Process each .properties file in the input directory
        fileTree(inputDir).matching {
            include "**/messages*.properties"
        }.each { file ->
            def relativePath = inputDir.toPath().relativize(file.toPath()).toString()
            def outputFile = new File(outputDir, relativePath)
            outputFile.parentFile.mkdirs()
            println "converting: ${file}"
            outputFile.withWriter("UTF-8") { writer ->
                file.eachLine("UTF-8") { line -> writer.writeLine((String) convertToUnicode(line))
                }
            }
        }
        println "‚úÖ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤: ${outputDir}"
    }

}

tasks.register("custom-scp", Exec) {
    group = "custom"
    description = "–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ scp –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —Å–±–æ—Ä–∫–∏. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (—Ü–µ–ª—å build)"

    dependsOn("custom-build")

    def jarFile = layout.buildDirectory.file("libs/${project.name}-${project.version}.jar").get().asFile.absolutePath

    def remoteHost = "helios.se.ifmo.ru"
    def remoteUser = "s409342"
    def remoteDirWebLab4 = "~/web_lab4"


    doFirst {
        println "Copying JAR to ${remoteUser}@${remoteHost}:${remoteDirWebLab4}"
    }

    commandLine "scp", "-P 2222", jarFile, "${remoteUser}@${remoteHost}:${remoteDirWebLab4}"

    doLast {
        println '‚úÖjar-–∞—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä'
    }
}

tasks.register("xml") {
    group = "custom"
    description = "–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö xml-—Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ"

    def xmlFilesDir = layout.projectDirectory.dir("src/main/resources").asFileTree // –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å xml-—Ñ–∞–π–ª–∞–º–∏

    doLast {
        def script = new GroovyShell().parse(file('scripts/validateXml.groovy'))

        xmlFilesDir.each { file ->
            if (file.absolutePath.endsWith(".xml")) {
                println "–≤–∞–ª–∏–¥–∏—Ä—É—é —Ñ–∞–π–ª: ${file.name}\n"
                script.validateXmlFile(file)
            }

        }
        println "‚úÖ–≤–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    }
}

tasks.register("music") {
    group = "custom"
    description = "–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —Å–±–æ—Ä–∫–∏ (—Ü–µ–ª—å build)"

    dependsOn "custom-build"

    def musicFile = file("src/main/resources/–ú–∞–∫—Å –ö–æ—Ä–∂ - –ú–∞–ª—ã–π –ø–æ–≤–∑—Ä–æ—Å–ª–µ–ª.mp3") // –ø—É—Ç—å –¥–æ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞

    doLast {
        if (!musicFile.exists()) {
            throw new GradleException("–Ω–µ –±—É–¥–µ—Ç –ø–æ–¥–ª–æ–π –µ–≤—Ä–µ–π—Å–∫–æ–π –º—É–∑—ã–∫–∏, —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${musicFile} (")
        }

        exec {
            executable = 'afplay'
            args = [musicFile.absolutePath]
        }
        println "‚úÖ–º—É–∑—ã–∫–∞"
    }
}

import java.security.MessageDigest

tasks.register('doc') {
    group = 'custom'
    description = '–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ MANIFEST.MF MD5 –∏ SHA-1 —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞, –∞ —Ç–∞–∫–∂–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∞—Ä—Ö–∏–≤ javadoc –ø–æ –≤—Å–µ–º –∫–ª–∞—Å—Å–∞–º –ø—Ä–æ–µ–∫—Ç–∞.'

    dependsOn 'custom-compile'

    def outputDir = layout.buildDirectory.dir("classes/java/main/com/example/web4_2").get().asFile
    def manifestFile = layout.buildDirectory.file("tmp/custom-build/MANIFEST.MF").get().asFile
    def javadocDir = layout.buildDirectory.dir("docs/javadoc").get().asFile
    def javadocJar = layout.buildDirectory.file("docs/javadoc.jar").get().asFile

    doLast {
        println "–≥–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã MD5 SHA-1..."

        def files = outputDir.listFiles().findAll { it.isFile() }

        def md5Digest = MessageDigest.getInstance("MD5")
        def sha1Digest = MessageDigest.getInstance("SHA-1")

        def md5Strings = []
        def sha1Strings = []

        files.each { file ->
            def bytes = file.bytes
            md5Digest.update(bytes)
            sha1Digest.update(bytes)

            def md5Hex = md5Digest.digest().encodeHex().toString()
            def sha1Hex = sha1Digest.digest().encodeHex().toString()

            md5Strings << "${file.name}: $md5Hex"
            sha1Strings << "${file.name}: $sha1Hex"

            // –û–±–Ω—É–ª—è–µ–º digest –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
            md5Digest.reset()
            sha1Digest.reset()
        }

        // –î–æ–ø–∏—Å—ã–≤–∞–µ–º –≤ MANIFEST
        manifestFile.parentFile.mkdirs()
        manifestFile.text += "\r\n" // –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
        manifestFile.text += "MD5-Checksums: ${md5Strings.join(', ')}\r\n"
        manifestFile.text += "SHA1-Checksums: ${sha1Strings.join(', ')}\r\n"

        println "MD5 –∏ SHA-1 –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç"

        println "–≥–µ–Ω–µ—Ä–∏—Ä—É—é Javadoc..."

        ant.javadoc(destdir: javadocDir,
                sourcepath: sourceSets.main.java.srcDirs.join(File.pathSeparator),
                packagenames: "*",
                classpath: configurations.runtimeClasspath.asPath,
                encoding: "UTF-8")

        ant.jar(destfile: javadocJar,
                basedir: javadocDir)

        println "‚úÖ–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Javadoc —É—Å–ø–µ—à–Ω–æ —Å–æ–¥–∞–Ω–∞: ${javadocJar}"
    }
}

tasks.register('custom-diff') {
    group = 'custom'
    description = '–æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–±–æ—á–µ–π –∫–æ–ø–∏–∏, –∏, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Å–∞—é—Ç—Å—è –∫–ª–∞—Å—Å–æ–≤, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç commit –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π git.'

    def paramFile = file('monitoring_classes.txt')

    inputs.file paramFile
    outputs.dir layout.buildDirectory.dir('git-status')

    doLast {
        def modifiedClasses = []
        def monitoredClasses = paramFile.readLines().collect {
            it.trim()
        }.findAll {
            it
        }

        def gitStatusResult = new ByteArrayOutputStream()
        exec {
            commandLine 'git', 'status', '--porcelain'
            standardOutput = gitStatusResult
        }

        def gitStatus = gitStatusResult.toString().trim()

        gitStatus.eachLine { line ->
            def parts = line.trim().split(" ", 2)
            def typeOfChange = parts[0] // M: Modified A: Added D: Deleted R: Renamed C: Copied U: Unmerged ??: Untracked
            def filePath = parts[1]


            if (filePath.endsWith('.java')) {
                def className = filePath.replace('.java', '').replace('/', '.')

                if (monitoredClasses.contains(className)) {
                    modifiedClasses << filePath
                    println "‚öôÔ∏è–±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Å–∞–µ–º–æ —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞: $className"
                }
            }
        }

        if (modifiedClasses) {
            println "‚öôÔ∏è—Å–µ–π—á–∞—Å —è —Å–¥–µ–ª–∞—é –∫–æ–º–º–∏—Ç..."
            exec {
                commandLine 'git', 'add', modifiedClasses.join(" ")
            }
            exec {
                commandLine 'git', 'commit', '-m', "committing changes for monitored classes: ${modifiedClasses.join(', ')}"
            }
            println "‚úÖ–∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Å–∞–µ–º–æ –∫–ª–∞—Å—Å–æ–≤ ${modifiedClasses.join(', ')} –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
        } else {
            println "‚úÖ–≤ –∫–ª–∞—Å—Å—ã, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤ monitoring_classes.txt –Ω–µ –±—ã–ª–æ –≤–Ω–µ—Å–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        }
    }
}

tasks.register('custom-env') {
    group = 'custom'
    description = '–æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç —Å–±–æ—Ä–∫—É –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö; ' + '–æ–∫—Ä—É–∂–µ–Ω–∏–µ –∑–∞–¥–∞–µ—Ç—Å—è –≤–µ—Ä—Å–∏–µ–π java –∏ –Ω–∞–±–æ—Ä–æ–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã –≤ —Ñ–∞–π–ª–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.'

    def envFile = file('env.properties')

    inputs.file envFile
    outputs.dir layout.buildDirectory.dir('env-output')

    doLast {
        def props = new Properties()
        envFile.withInputStream {
            props.load(it)
        }
        def javaVersion = props.getProperty('java.version')
        def jvmArgsList = props.getProperty('jvm.args', '').split("\\s+").findAll { it }

        println "üõ† –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Java –≤–µ—Ä—Å–∏—è: $javaVersion"
        println "üõ† JVM –∞—Ä–≥—É–º–µ–Ω—Ç—ã: $jvmArgsList"


        def jarPath = "${buildDir}/libs/web4_2-0.0.1-SNAPSHOT.jar"
        exec {
            executable("java")
            args(jvmArgsList + ["-jar", jarPath])
        }
    }
}

tasks.register('alt-helper-replace') {
    group = 'custom'
    description = '—Å–æ–∑–¥–∞—ë—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–ª–∞—Å—Å–æ–≤ ' + '(–∏—Å–ø–æ–ª—å–∑—É—è –∑–∞–¥–∞–Ω–∏–µ replace/replaceregexp –≤ —Ñ–∞–π–ª–∞—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) –∏ —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –µ—ë –≤ jar-–∞—Ä—Ö–∏–≤.' + ' –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è jar-–∞—Ä—Ö–∏–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–ª—å build.'

    // —è —Ö–æ—á—É –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫—É —Å—Ä—Ü –≤ –∞–ª—å—Ç—Å—Ä—Ü–¥–∏—Ä - –≤ –Ω–µ–π –∏–∑–º–µ–Ω—è—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–∞–π–ª—ã
    // –∏–∑–º–µ–Ω—è—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ä—Ü–¥–∏—Ä + –≤—ã–∑—ã–≤–∞—Ç—å build
    def srcDirs = sourceSets.main.java.srcDirs
    def altSrcDirs = layout.projectDirectory.dir("altSrc").asFile
    if (altSrcDirs.exists()) {
        project.delete(altSrcDirs)
    }
    altSrcDirs.mkdirs()
    copy {
        from srcDirs
        into altSrcDirs
    }
//    def testFolder = new File(altSrcDirs, "test")
//    if (testFolder.exists()) {
//        project.delete(testFolder)
//    }
    // –∫–∞–∫ –º–Ω–µ –∏–∑ altSrcDirs —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É —Ç–µ—Å—Ç?
    def replacementsFile = layout.projectDirectory.file("replacements.properties").asFile
    def replacements = new Properties()
    replacementsFile.withInputStream {
        replacements.load(it)
    }

    altSrcDirs.eachFileRecurse { file ->

        if (file.name.endsWith('.java')) {
            def text = file.text
            replacements.each { key, value ->
                println "‚öôÔ∏è–∑–∞–º–µ–Ω—è—é $key –Ω–∞ $value –≤ ${file.name}..."
                text = text.replaceAll(key, value)
            }
            file.text = text

            replacements.each { key, value ->
                if (file.name == "${key}.java") {
                    println "‚öôÔ∏è–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—é —Ñ–∞–π–ª ${file.name} –≤ ${value}.java..."
                    def newFile = new File(file.parentFile, "${value}.java")
                    if (!file.renameTo(newFile)) {
                        throw new GradleException("–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª ${file.name} –≤ ${newFile.name} (")
                    }
                    println "—Ñ–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: ${file.name} ‚Üí ${newFile.name}"
                } else {
                    if (file.name.contains(key)) {
                        println "‚öôÔ∏è–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—é —Ñ–∞–π–ª ${file.name} –≤ ${file.name.replace(key, value)}..."
                        value = file.name.replace(key, value)
                        def newFile = new File(file.parentFile, "${value}")
                        if (!file.renameTo(newFile)) {
                            throw new GradleException("–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª ${file.name} –≤ ${newFile.name} (")
                        }
                        println "—Ñ–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: ${file.name} ‚Üí ${newFile.name}"

                    }
                }
            }
        }
    }


}
tasks.register('alt-helper-cleanup') {
    group = 'custom'
    description = '–æ—á–∏—Å—Ç–∫–∞ altSrc –∏ —Å–±—Ä–æ—Å useAltSrc'

    doLast {
        println "‚öôÔ∏è–æ—á–∏—â–∞—é altSrc –∏ —Å–±—Ä–∞—Å—ã–≤–∞—é useAltSrc..."
        def altSrcDir = layout.projectDirectory.dir("altSrc").asFile

        if (altSrcDir.exists()) {
            project.delete(altSrcDir)
            println "‚úÖaltSrc —É–¥–∞–ª—ë–Ω."
        }

        project.ext.useAltSrc = false
        println "‚úÖproject.ext.useAltSrc —Å–±—Ä–æ—à–µ–Ω –≤ false."
    }
}
tasks.register('alt-helper-print-success') {
    group = 'custom'
    description = '–≤—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏'
    dependsOn 'alt-helper-cleanup'

    doLast {
        println "‚úÖ–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–∞ –∏ —É–ø–∞–∫–æ–≤–∞–Ω–∞ –≤ jar-–∞—Ä—Ö–∏–≤."
    }
}

tasks.register('custom-alt') {
    group = 'custom'
    description = '—Å–æ–∑–¥–∞—ë—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–ª–∞—Å—Å–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É—è –∑–∞–¥–∞–Ω–∏–µ replace/replaceregexp –≤ —Ñ–∞–π–ª–∞—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) –∏ —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –µ—ë –≤ jar-–∞—Ä—Ö–∏–≤.' + ' –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è jar-–∞—Ä—Ö–∏–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–ª—å build.'

    dependsOn 'alt-helper-replace'

    doFirst {
        project.ext.useAltSrc = true
    }

    finalizedBy 'custom-build', 'alt-helper-cleanup', 'alt-helper-print-success'

}


tasks.register('history') {
    group = 'custom'
    description = '–µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ —É–¥–∞—ë—Ç—Å—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å (—Ü–µ–ª—å compile), –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è git. '
    + '–û–ø–µ—Ä–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –ø—Ä–æ–µ–∫—Ç –Ω–µ —É–¥–∞—Å—Ç—Å—è —Å–æ–±—Ä–∞—Ç—å, –ª–∏–±–æ –Ω–µ –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω–∞ —Å–∞–º–∞—è –ø–µ—Ä–≤–∞—è —Ä–µ–≤–∏–∑–∏—è ' +
            '–∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ï—Å–ª–∏ —Ç–∞–∫–∞—è —Ä–µ–≤–∏–∑–∏—è –Ω–∞–π–¥–µ–Ω–∞, —Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Ñ–∞–π–ª, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ ' +
            'diff –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º—ë–Ω–µ–Ω–Ω—ã—Ö –≤ —Ä–µ–≤–∏–∑–∏–∏, —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–∞–±–æ—Ç–∞—é—â–µ–π.'

    def originalHead = ''
    def workingRevision = ''
    def previousRevision = ''
    def out = new ByteArrayOutputStream()


    doFirst {
        exec {
            commandLine 'git', 'rev-parse', 'HEAD'
            standardOutput = out
        }
        originalHead = out.toString().trim()

        exec {
            commandLine 'git', 'log', '--pretty=format:%H'
            standardOutput = out
        }

        List<String> gitLog = out.toString().trim().isEmpty() ? [] : out.toString().trim().split("\n").toList()

        println "‚öôÔ∏è–∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${gitLog.size()} –∫–æ–º–º–∏—Ç–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"

        if (gitLog.size() == 0) {
            throw new GradleException("‚ùå–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏ git(")
        }

        for (int i = 0; i < gitLog.size(); i++) {
            def rev = gitLog[i]
            println "‚öôÔ∏è–ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ä–µ–≤–∏–∑–∏—é: $rev"
            exec {
                commandLine 'git', 'checkout', rev
            }
            try {
                exec {
                    commandLine './gradlew', 'custom-compile'
                }
                println "‚úÖ–ø—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏: $rev"

                workingRevision = rev
                previousRevision = (i > 0) ? gitLog[i - 1] : null
                exec {
                    commandLine 'git', 'branch', '-f', 'master', rev
                }

                break
            } catch (Exception e) {
                println "‚ùå–æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏: $rev (("
            }
        }

        if (!workingRevision) {
            throw new GradleException("‚ùå–Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—á—É—é —Ä–µ–≤–∏–∑–∏—é! –¥–∞–∂–µ —Å–∞–º–∞—è –ø–µ—Ä–≤–∞—è –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è (")
        }

        if (previousRevision) {
            println "‚öôÔ∏è—Ñ–æ—Ä–º–∏—Ä—É—é diff –º–µ–∂–¥—É $workingRevision –∏ $previousRevision"
            def diffFile = layout.buildDirectory.file("history/diff.txt").get().asFile
            diffFile.parentFile.mkdirs()

            exec {
                commandLine 'git', 'diff', workingRevision, previousRevision
                standardOutput = new FileOutputStream(diffFile)
            }

            println "‚úÖ—Ä–µ–∑—É–ª—å—Ç–∞—Ç git diff —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: ${diffFile.absolutePath.replace(projectDir.absolutePath + '/', '')}"
        } else {
            println "‚úÖ—Ä–∞–±–æ—á–∞—è —Ä–µ–≤–∏–∑–∏—è ‚Äî —Å–∞–º–∞—è –Ω–æ–≤–∞—è. –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è diff."
        }
    }
}


tasks.register('team') {
    group = 'custom'
    description = '–æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è 4 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–≤–∏–∑–∏–π, –∏—Ö —Å–±–æ—Ä–∫—É (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ ' + '—Å –æ—Å–Ω–æ–≤–Ω–æ–π) –∏ —É–ø–∞–∫–æ–≤–∫—É –ø–æ–ª—É—á–∏–≤—à–∏—Ö—Å—è jar-—Ñ–∞–π–ª–æ–≤ –≤ zip-–∞—Ä—Ö–∏–≤. –°–±–æ—Ä–∫—É —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –≤—ã–∑–æ–≤–∞ —Ü–µ–ª–∏ build.'

    def teamBuildDir = layout.buildDirectory.dir("team-jars").get().asFile
    def zipOutput = layout.buildDirectory.file("team-jars/team_builds.zip").get().asFile

    doLast {
        def originalRev = getCurrentGitRevision()

        def revisions = getLastGitRevisions(4)

        if (teamBuildDir.exists()) {
            project.delete(teamBuildDir)
        }
        teamBuildDir.mkdirs()

        revisions.eachWithIndex { rev, idx ->
            println "‚öôÔ∏è–ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ä–µ–≤–∏–∑–∏—é: $rev"
            gitCheckout(rev)

            try {
                println "‚öôÔ∏è–±–∏–ª–¥ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏ $rev"
                exec {
                    commandLine './gradlew', 'custom-build'
                }

                def jarName = "${project.name}-${project.version}-rev${idx + 1}.jar"
                def builtJar = file("${buildDir}/libs/${project.name}-${project.version}.jar")

                if (!builtJar.exists()) {
                    throw new GradleException("‚ùåjar-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏: $rev")
                }

                copy {
                    from builtJar
                    into teamBuildDir
                    rename { jarName }
                }

                println "‚úÖ–±–∏–ª–¥ —Ä–µ–≤–∏–∑–∏–∏ $rev —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"

            } catch (Exception e) {
                println "‚ùå–æ—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏ $rev: ${e.message}"
            }
        }

        gitCheckout(originalRev)

        println "‚öôÔ∏è—É–ø–∞–∫–æ–≤—ã–≤–∞—é jar-–∞—Ä—Ö–∏–≤—ã –≤ zip-–∞—Ä—Ö–∏–≤..."
        ant.zip(destfile: zipOutput) {
            fileset(dir: teamBuildDir)
        }

        println "‚úÖ—É–ø–∞–∫–æ–≤–∫–∞ 4 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–≤–∏–∑–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞! " + "zip-–∞—Ä—Ö–∏–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–¥–µ—Å—å: ${zipOutput.absolutePath.replace(projectDir.absolutePath + '/', '')}"
    }
}

// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–≤–∏–∑–∏—é
String getCurrentGitRevision() {
    def out = new ByteArrayOutputStream()
    exec {
        executable = "git"
        args = ["rev-parse", "HEAD"]
        workingDir = project.projectDir
        standardOutput = out
        errorOutput = out
        ignoreExitValue = true
    }
    return out.toString().trim()
}

// –ü–æ–ª—É—á–∏—Ç—å N –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–≤–∏–∑–∏–π
List<String> getLastGitRevisions(int count) {
    def out = new ByteArrayOutputStream()
    exec {
        executable = "git"
        args = ["rev-list", "-n", "$count", "HEAD"]
        workingDir = project.projectDir
        standardOutput = out
        errorOutput = out
        ignoreExitValue = true
    }
    return out.toString().trim().split("\n").toList()
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ä–µ–≤–∏–∑–∏—é
void gitCheckout(String revision) {
    exec {
        executable = "git"
        args = ["checkout", revision]
        workingDir = project.projectDir
    }
}

